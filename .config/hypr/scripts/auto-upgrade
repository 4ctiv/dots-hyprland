#!/bin/bash
#
# This scrip will attempt to upgrade packages using the arch package manager.
# Note: In non interactive mode this will only request an upgrade after
#       a certain threshold is reached.
#       In an interactive (tty) session the threshold is automatically ignored.

which checkupdates > /dev/null || sudo pacman -S pacman-contrib;

old_dir="$(dir)"
out_of_date_packs=$(checkupdates | wc -l)
OUTDATED_ALLOWED=50
PKG_MGR="paru"  # if unset default to pacman (no aur helper)
FORCE_UPDATE=0

if [[ "$1" == "--force" ]] || [[ "$1" == "-f" ]];then
  FORCE_UPDATE=1
  echo "Forcing update"
  shift 1;
fi

# Setup aur helper manager: paru
if [[ "${PKG_MGR}" == "paru" ]] && [[ ! -f "$(which paru)" ]]; then
  [[ ! -f "$(which git)" ]] || pacman -S git
  git clone https://aur.archlinux.org/paru.git paru_setup &&\
    cd paru_setup &&\
    makepkg -si &&\
    cd .. &&\
  rm -rf paru_setup
fi

# Setup aur helper manager: yay
if [ "${PKG_MGR}" == "yay" ] && [ ! -f "$(which yay 2>/dev/null)" ]; then
  [ ! -f $(which git) ] || pacman -S git base-devel
  git clone https://aur.archlinux.org/yay.git yay_setup &&\
  cd yay-setup &&\
  makepkg -si &&\
  cd "$old_dir" &&\
  rm -rf yay-setup
fi

# Only update if >= X packages are out of date (idea: stabe system intervalls)
if [[ $out_of_date_packs -ge $OUTDATED_ALLOWED ]] || [[ $FORCE_UPDATE > 0 ]]; then
  kitty --name "Auto_Update" --title "Auto_Update" sh -c \
   "echo 'Requesting System upgrade ($out_of_date_packs packages)'; ${PKG_MGR:-pacman} -Syu --noconfirm; read -n 1 -s -p 'Press [ANY] key to continue ...' dummy; exit 0" \
   > /dev/null
  [ $(checkupdates | wc -l) -eq 0 ] && echo "Auto Update Success" || (echo "Auto Update Failed")
else
  msg="Less than $OUTDATED_ALLOWED packages outdated => skipping update"
  if [[ "$(tty)" =~ "not a tty" ]]; then
    notify-send "$msg"
  else
    echo "$msg"
  fi
fi

pkill -RTMIN+8 waybar >/dev/null 2>/dev/null # Update waybar displayed packages

exit 0
